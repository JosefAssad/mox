*** ../generated-files/as_update_klasse.sql	2015-08-07 15:13:57.848868564 +0200
--- ../patches/as_update_klasse.org.sql	2015-08-07 15:16:01.420874719 +0200
***************
*** 9,20 ****
  NOTICE: This file is auto-generated using the script: apply-template.py klasse as_update.jinja.sql
  */
  
  
  
  
! --Also notice, that the given arrays of KlasseAttr...Type must be consistent regarding virkning (although the allowance of null-values might make it possible to construct 'logically consistent'-arrays of objects with overlapping virknings)
  
  CREATE OR REPLACE FUNCTION as_update_klasse(
    klasse_uuid uuid,
    brugerref uuid,
    note text,
--- 9,22 ----
  NOTICE: This file is auto-generated using the script: apply-template.py klasse as_update.jinja.sql
  */
  
  
  
+ --Please notice that is it the responsibility of the invoker of this function to compare the resulting klasse_registration (including the entire hierarchy)
+ --to the previous one, and abort the transaction if the two registrations are identical. (This is to comply with the stipulated behavior in 'Specifikation_af_generelle_egenskaber - til OIOkomiteen.pdf')
  
! --Also notice, that the given array of KlasseAttr...Type must be consistent regarding virkning (although the allowance of null-values might make it possible to construct 'logically consistent'-arrays of objects with overlapping virknings)
  
  CREATE OR REPLACE FUNCTION as_update_klasse(
    klasse_uuid uuid,
    brugerref uuid,
    note text,
***************
*** 33,42 ****
--- 35,46 ----
    read_prev_klasse_reg KlasseRegistreringType;
    new_klasse_registrering klasse_registrering;
    prev_klasse_registrering klasse_registrering;
    klasse_relation_navn KlasseRelationKode;
    attrEgenskaberObj KlasseEgenskaberAttrType;
+   new_id_klasse_attr_egenskaber bigint;
+   klasseSoegeordObj KlasseSoegeordType;
  BEGIN
  
  --create a new registrering
  
  IF NOT EXISTS (select a.id from klasse a join klasse_registrering b on b.klasse_id=a.id  where a.id=klasse_uuid) THEN
***************
*** 268,278 ****
    IF EXISTS (
    SELECT
    a.*
    FROM unnest(attrEgenskaber) a
    JOIN  unnest(attrEgenskaber) b on (a.virkning).TimePeriod && (b.virkning).TimePeriod
!   GROUP BY a.brugervendtnoegle,a.beskrivelse,a.eksempel,a.omfang,a.titel,a.retskilde,a.aendringsnotat, a.virkning
    HAVING COUNT(*)>1
    ) THEN
    RAISE EXCEPTION 'Unable to update klasse with uuid [%], as the klasse have overlapping virknings in the given egenskaber array :%',klasse_uuid,to_json(attrEgenskaber)  USING ERRCODE = 22000;
  
    END IF;
--- 272,282 ----
    IF EXISTS (
    SELECT
    a.*
    FROM unnest(attrEgenskaber) a
    JOIN  unnest(attrEgenskaber) b on (a.virkning).TimePeriod && (b.virkning).TimePeriod
!   GROUP BY a.brugervendtnoegle,a.beskrivelse,a.eksempel,a.omfang,a.titel,a.retskilde,a.aendringsnotat, a.virkning, a.soegeord
    HAVING COUNT(*)>1
    ) THEN
    RAISE EXCEPTION 'Unable to update klasse with uuid [%], as the klasse have overlapping virknings in the given egenskaber array :%',klasse_uuid,to_json(attrEgenskaber)  USING ERRCODE = 22000;
  
    END IF;
***************
*** 289,306 ****
     (attrEgenskaberObj).titel is null OR 
     (attrEgenskaberObj).retskilde is null OR 
     (attrEgenskaberObj).aendringsnotat is null 
    THEN
  
    INSERT INTO
    klasse_attr_egenskaber
    (
!     brugervendtnoegle,beskrivelse,eksempel,omfang,titel,retskilde,aendringsnotat
      ,virkning
      ,klasse_registrering_id
    )
!   SELECT
      coalesce(attrEgenskaberObj.brugervendtnoegle,a.brugervendtnoegle),
      coalesce(attrEgenskaberObj.beskrivelse,a.beskrivelse),
      coalesce(attrEgenskaberObj.eksempel,a.eksempel),
      coalesce(attrEgenskaberObj.omfang,a.omfang),
      coalesce(attrEgenskaberObj.titel,a.titel),
--- 293,312 ----
     (attrEgenskaberObj).titel is null OR 
     (attrEgenskaberObj).retskilde is null OR 
     (attrEgenskaberObj).aendringsnotat is null 
    THEN
  
+ WITH inserted_merged_attr_egenskaber AS (
    INSERT INTO
    klasse_attr_egenskaber
    (
!     id,brugervendtnoegle,beskrivelse,eksempel,omfang,titel,retskilde,aendringsnotat
      ,virkning
      ,klasse_registrering_id
    )
!   SELECT 
!     nextval('klasse_attr_egenskaber_id_seq'),
      coalesce(attrEgenskaberObj.brugervendtnoegle,a.brugervendtnoegle),
      coalesce(attrEgenskaberObj.beskrivelse,a.beskrivelse),
      coalesce(attrEgenskaberObj.eksempel,a.eksempel),
      coalesce(attrEgenskaberObj.omfang,a.omfang),
      coalesce(attrEgenskaberObj.titel,a.titel),
***************
*** 315,336 ****
      new_klasse_registrering.id
    FROM klasse_attr_egenskaber a
    WHERE
      a.klasse_registrering_id=prev_klasse_registrering.id 
      and (a.virkning).TimePeriod && (attrEgenskaberObj.virkning).TimePeriod
!   ;
  
    --For any periods within the virkning of the attrEgenskaberObj, that is NOT covered by any "merged" rows inserted above, generate and insert rows
  
    INSERT INTO
    klasse_attr_egenskaber
    (
!     brugervendtnoegle,beskrivelse,eksempel,omfang,titel,retskilde,aendringsnotat
      ,virkning
      ,klasse_registrering_id
    )
    SELECT 
      attrEgenskaberObj.brugervendtnoegle, 
      attrEgenskaberObj.beskrivelse, 
      attrEgenskaberObj.eksempel, 
      attrEgenskaberObj.omfang, 
      attrEgenskaberObj.titel, 
--- 321,367 ----
      new_klasse_registrering.id
    FROM klasse_attr_egenskaber a
    WHERE
      a.klasse_registrering_id=prev_klasse_registrering.id 
      and (a.virkning).TimePeriod && (attrEgenskaberObj.virkning).TimePeriod
!     RETURNING id new_id,(virkning).TimePeriod merged_timeperiod
! )
! INSERT INTO 
! klasse_attr_egenskaber_soegeord 
! (soegeordidentifikator,beskrivelse,soegeordskategori,klasse_attr_egenskaber_id)
! SELECT
!   coalesce(b.soegeordidentifikator,c.soegeordidentifikator), --please notice that this is not a merge - one of the joins on b or c will fail.
!   coalesce(b.beskrivelse,c.beskrivelse),--please notice that this is not a merge - one of the joins on b or c will fail.
!   coalesce(b.soegeordskategori,c.soegeordskategori),--please notice that this is not a merge - one of the joins on b or c will fail.
!   a.new_id
! FROM inserted_merged_attr_egenskaber a
! LEFT JOIN unnest(attrEgenskaberObj.soegeord) as b(soegeordidentifikator,beskrivelse,soegeordskategori) on attrEgenskaberObj.soegeord IS NOT NULL
! LEFT JOIN klasse_attr_egenskaber as b2 on attrEgenskaberObj.soegeord IS NULL and b2.klasse_registrering_id=prev_klasse_registrering.id and (b2.virkning).TimePeriod @> a.merged_timeperiod --Please notice, that this will max hit exactly one row - the row that the new id was merged with
! LEFT JOIN klasse_attr_egenskaber_soegeord as c on attrEgenskaberObj.soegeord IS NULL AND c.klasse_attr_egenskaber_id = b2.id
! WHERE 
!   (
!     (attrEgenskaberObj.soegeord IS NULL and c.id is not null) --there is sogeord of merged egenskab
!     or
!     coalesce(array_length(attrEgenskaberObj.soegeord,1),0)>0   --soegeord is defined in array 
!   )
!   and
!   (NOT (attrEgenskaberObj.soegeord IS NOT NULL AND array_length(attrEgenskaberObj.soegeord,1)=0)) --if the array is empty, no sogeord should be inserted  
! 
! ;
  
    --For any periods within the virkning of the attrEgenskaberObj, that is NOT covered by any "merged" rows inserted above, generate and insert rows
  
+ WITH inserted_attr_egenskaber AS (
    INSERT INTO
    klasse_attr_egenskaber
    (
!     id,brugervendtnoegle,beskrivelse,eksempel,omfang,titel,retskilde,aendringsnotat
      ,virkning
      ,klasse_registrering_id
    )
    SELECT 
+     nextval('klasse_attr_egenskaber_id_seq'),
      attrEgenskaberObj.brugervendtnoegle, 
      attrEgenskaberObj.beskrivelse, 
      attrEgenskaberObj.eksempel, 
      attrEgenskaberObj.omfang, 
      attrEgenskaberObj.titel, 
***************
*** 350,382 ****
        FROM klasse_attr_egenskaber b
        WHERE 
         b.klasse_registrering_id=new_klasse_registrering.id
    ) as a
    JOIN unnest(_subtract_tstzrange_arr((attrEgenskaberObj.virkning).TimePeriod,a.tzranges_of_new_reg)) as b(tz_range_leftover) on true
!   ;
  
    ELSE
      --insert attrEgenskaberObj raw (if there were no null-valued fields) 
  
      INSERT INTO
      klasse_attr_egenskaber
      (
!     brugervendtnoegle,beskrivelse,eksempel,omfang,titel,retskilde,aendringsnotat
      ,virkning
      ,klasse_registrering_id
      )
      VALUES ( 
      attrEgenskaberObj.brugervendtnoegle, 
      attrEgenskaberObj.beskrivelse, 
      attrEgenskaberObj.eksempel, 
      attrEgenskaberObj.omfang, 
      attrEgenskaberObj.titel, 
      attrEgenskaberObj.retskilde, 
      attrEgenskaberObj.aendringsnotat,
      attrEgenskaberObj.virkning,
      new_klasse_registrering.id
!     );
  
    END IF;
  
    END LOOP;
  END IF;
--- 381,447 ----
        FROM klasse_attr_egenskaber b
        WHERE 
         b.klasse_registrering_id=new_klasse_registrering.id
    ) as a
    JOIN unnest(_subtract_tstzrange_arr((attrEgenskaberObj.virkning).TimePeriod,a.tzranges_of_new_reg)) as b(tz_range_leftover) on true
!   RETURNING id
!   )
! INSERT INTO 
! klasse_attr_egenskaber_soegeord 
! (soegeordidentifikator,beskrivelse,soegeordskategori,klasse_attr_egenskaber_id)
! SELECT
! a.soegeordidentifikator,a.beskrivelse,a.soegeordskategori,b.id
! FROM
! unnest(attrEgenskaberObj.soegeord) as a(soegeordidentifikator,beskrivelse,soegeordskategori)
! JOIN inserted_attr_egenskaber b on true
! ;
! 
! 
  
    ELSE
      --insert attrEgenskaberObj raw (if there were no null-valued fields) 
  
+     new_id_klasse_attr_egenskaber:=nextval('klasse_attr_egenskaber_id_seq');
+ 
      INSERT INTO
      klasse_attr_egenskaber
      (
!     id,brugervendtnoegle,beskrivelse,eksempel,omfang,titel,retskilde,aendringsnotat
      ,virkning
      ,klasse_registrering_id
      )
      VALUES ( 
+     new_id_klasse_attr_egenskaber,
      attrEgenskaberObj.brugervendtnoegle, 
      attrEgenskaberObj.beskrivelse, 
      attrEgenskaberObj.eksempel, 
      attrEgenskaberObj.omfang, 
      attrEgenskaberObj.titel, 
      attrEgenskaberObj.retskilde, 
      attrEgenskaberObj.aendringsnotat,
      attrEgenskaberObj.virkning,
      new_klasse_registrering.id
!     )
!     ;
!    
!     IF attrEgenskaberObj.soegeord IS NOT NULL THEN
!     INSERT INTO klasse_attr_egenskaber_soegeord( 
!           soegeordidentifikator,
!           beskrivelse,
!           soegeordskategori,
!           klasse_attr_egenskaber_id
!           )
!     SELECT
!     a.soegeordidentifikator,
!     a.beskrivelse,
!     a.soegeordskategori,
!     new_id_klasse_attr_egenskaber
!     FROM
!     unnest(attrEgenskaberObj.soegeord) as a(soegeordidentifikator,beskrivelse,soegeordskategori)
!     ;
!     END IF;
! 
  
    END IF;
  
    END LOOP;
  END IF;
***************
*** 386,401 ****
  --raise debug 'Skipping handling of egenskaber of previous registration as an empty array was explicit given.';  
  ELSE 
  
  --Handle egenskaber of previous registration, taking overlapping virknings into consideration (using function subtract_tstzrange)
  
  INSERT INTO klasse_attr_egenskaber (
!     brugervendtnoegle,beskrivelse,eksempel,omfang,titel,retskilde,aendringsnotat
      ,virkning
      ,klasse_registrering_id
  )
  SELECT
        a.brugervendtnoegle,
        a.beskrivelse,
        a.eksempel,
        a.omfang,
        a.titel,
--- 451,469 ----
  --raise debug 'Skipping handling of egenskaber of previous registration as an empty array was explicit given.';  
  ELSE 
  
  --Handle egenskaber of previous registration, taking overlapping virknings into consideration (using function subtract_tstzrange)
  
+ 
+ WITH copied_attr_egenskaber AS (
  INSERT INTO klasse_attr_egenskaber (
!     id,brugervendtnoegle,beskrivelse,eksempel,omfang,titel,retskilde,aendringsnotat
      ,virkning
      ,klasse_registrering_id
  )
  SELECT
+       nextval('klasse_attr_egenskaber_id_seq'),
        a.brugervendtnoegle,
        a.beskrivelse,
        a.eksempel,
        a.omfang,
        a.titel,
***************
*** 416,430 ****
      WHERE 
            b.klasse_registrering_id=new_klasse_registrering.id
  ) d
    JOIN klasse_attr_egenskaber a ON true  
    JOIN unnest(_subtract_tstzrange_arr((a.virkning).TimePeriod,tzranges_of_new_reg)) as c(tz_range_leftover) on true
!   WHERE a.klasse_registrering_id=prev_klasse_registrering.id     
  ;
  
- 
- 
  --Remove any "cleared"/"deleted" attributes
  DELETE FROM klasse_attr_egenskaber a
  WHERE 
  a.klasse_registrering_id=new_klasse_registrering.id
  AND (a.brugervendtnoegle IS NULL OR a.brugervendtnoegle='') 
--- 484,506 ----
      WHERE 
            b.klasse_registrering_id=new_klasse_registrering.id
  ) d
    JOIN klasse_attr_egenskaber a ON true  
    JOIN unnest(_subtract_tstzrange_arr((a.virkning).TimePeriod,tzranges_of_new_reg)) as c(tz_range_leftover) on true
!   WHERE a.klasse_registrering_id=prev_klasse_registrering.id 
!   RETURNING id new_id,(virkning).TimePeriod  
! )
! INSERT INTO 
! klasse_attr_egenskaber_soegeord 
! (soegeordidentifikator,beskrivelse,soegeordskategori,klasse_attr_egenskaber_id)
! SELECT
! b.soegeordidentifikator,b.beskrivelse,b.soegeordskategori,a.new_id
! FROM copied_attr_egenskaber a
! JOIN klasse_attr_egenskaber a2 on a2.klasse_registrering_id=prev_klasse_registrering.id and (a2.virkning).TimePeriod @> a.TimePeriod --this will hit exactly one row - that is, the row that we copied. 
! JOIN klasse_attr_egenskaber_soegeord b on a2.id=b.klasse_attr_egenskaber_id   
  ;
  
  --Remove any "cleared"/"deleted" attributes
  DELETE FROM klasse_attr_egenskaber a
  WHERE 
  a.klasse_registrering_id=new_klasse_registrering.id
  AND (a.brugervendtnoegle IS NULL OR a.brugervendtnoegle='') 
***************
*** 432,443 ****
--- 508,521 ----
              AND  (a.eksempel IS NULL OR a.eksempel='') 
              AND  (a.omfang IS NULL OR a.omfang='') 
              AND  (a.titel IS NULL OR a.titel='') 
              AND  (a.retskilde IS NULL OR a.retskilde='') 
              AND  (a.aendringsnotat IS NULL OR a.aendringsnotat='')
+ AND a.id NOT IN (SELECT b.klasse_attr_egenskaber_id FROM klasse_attr_egenskaber_soegeord b)
  ;
  
+ 
  END IF;
  
  
  /******************************************************************/
  --If the new registrering is identical to the previous one, we need to throw an exception to abort the transaction. 
